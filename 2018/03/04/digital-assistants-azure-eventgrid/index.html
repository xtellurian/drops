

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="I write here sometimes">
  <meta name="author" content="Rian Finnegan">
  <meta name="keywords" content="rian, finnegan, blog">
  <title>Digital Assistants &amp; Azure Event Grid - Thoughts of Rian</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Rian</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About Me
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/images/bg/rain.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2018-03-04 16:13" pubdate>
        Sunday, March 4th 2018, 4:13 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      1.3k words
    </span>
  

  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">Digital Assistants &amp; Azure Event Grid</h1>
            
            <div class="markdown-body" id="post-body">
              <p><img src="/images/robot.jpg" srcset="/img/loading.gif" alt="Robot Assistant Cartoon"></p>
<h2 id="The-Digital-World"><a href="#The-Digital-World" class="headerlink" title="The Digital World"></a>The Digital World</h2><p>The digital world exists at once everyone and nowhere. Things are happening there, at the speed of light. Those events effect our lives, but as physical beings it takes us time and effort to response. A digital assistant responds to events in the digital world, helping you that pervasive yet ephemeral environment. </p>
<p>As the digital world becomes busier and noisier, we need cloud-scale technologies that allow us to respond to events in real time. Azure event grid proves exactly that type of medium, for events on the web and in the cloud. Using event grid and bot framework, we can build bots that observe events in the grid, let you know when important things are happening, and provide options for responding.</p>
<h2 id="Azure-Event-Grid"><a href="#Azure-Event-Grid" class="headerlink" title="Azure Event Grid"></a>Azure Event Grid</h2><p>Azure Event Grid allows you to easily build applications with event-based architectures. You select the Azure resource you would like to subscribe to, and give the event handler or WebHook endpoint to send the event to. Event Grid has built-in support for events coming from Azure services, like storage blobs and resource groups. Event Grid also has custom support for application and third-party events, using custom topics and custom webhooks.</p>
<p><img src="https://docs.microsoft.com/en-us/azure/event-grid/media/overview/functional-model.png" srcset="/img/loading.gif" alt="Azure Event Grid Sources and Handers Diagram"></p>
<p>More publishers and handlers are being added. Event Grid is currently in preview, but is expected to be in GA by the end of 2017.</p>
<p>The best features of event grid are:</p>
<ul>
<li>Cloud Scale: Can support millions of events per second</li>
<li>Cloud Pricing: GA pricing will be $0.60 / million events</li>
<li>Low Latency: Events are delivered usually within a second</li>
<li>Flexible Schema: Arbitrary JSON payloads</li>
<li>Guaranteed Delivery: Retry policy and eventual consistency</li>
</ul>
<h2 id="Bots-in-the-Grid"><a href="#Bots-in-the-Grid" class="headerlink" title="Bots in the Grid"></a>Bots in the Grid</h2><p>Conversations are growing in popularity as an interface with the digital world. Conversations naturally morph between the synchronous and asynchronous, making them a perfect fit for how we interact with modern applications. </p>
<h3 id="Responding-to-Digital-Events"><a href="#Responding-to-Digital-Events" class="headerlink" title="Responding to Digital Events"></a>Responding to Digital Events</h3><p>The following shows how to listen for events with Microsoft Bot Framework. In this example, I’ll be using an ASP.NET bot, so this code will work for any ASP.NET application, and the same pattern holds for most web applications.</p>
<h3 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h3><p>Subscribing your bot to events is actually very simple. Just implement an http endpoint that receives incoming webhooks.</p>
<p><img src="/content/images/2017/10/boteventgridarchitecture.png" srcset="/img/loading.gif" alt="Architecture Diagram for Connecting Bots to Event Grid"></p>
<h4 id="Incoming-Event-Data-Structure"><a href="#Incoming-Event-Data-Structure" class="headerlink" title="Incoming Event Data Structure"></a>Incoming Event Data Structure</h4><p>Incoming events, via webhook, are delivered by the body of an HTTP Post. The following is an example:</p>
<pre><code class="hljs .language-json">&#123;[
  &#123;
    &quot;Data&quot;: &#123;
      &quot;Correlation&quot;: &#123;
        &quot;ExternalReferenceId&quot;: &quot;9c551c4f-9a73-4565-8590-b4b81b074dfb&quot;
      &#125;,
      &quot;To&quot;: &#123;
        &quot;Id&quot;: &quot;myUserId&quot;,
        &quot;DisplayName&quot;: &quot;Rian&quot;
      &#125;,
      &quot;Amount&quot;: 150.0,
      &quot;Message&quot;: &quot;Whatever you like&quot;
    &#125;,
    &quot;Id&quot;: &quot;fbfaab9e-a328-4c77-bee7-8fb95264d4fd&quot;,
    &quot;Subject&quot;: &quot;custom\\value&quot;,
    &quot;EventType&quot;: 0,
    &quot;EventTime&quot;: &quot;2017-10-25T23:01:37.3456283Z&quot;,
    &quot;topic&quot;: &quot;&#x2F;SUBSCRIPTIONS&#x2F;XXXXXXXX-XXXX-XXXX-XXXX-XX&#x2F;RESOURCEGROUPS&#x2F;YOUR-GROUP&#x2F;PROVIDERS&#x2F;MICROSOFT.EVENTGRID&#x2F;TOPICS&#x2F;YOUR_TOPIC&quot;
  &#125;
]&#125;</code></pre>
<p>Since this is a custom event, everything in the <em>Data</em> field is yours to play with. The other top level fields define how the event is processed within event grid.</p>
<h3 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h3><p>Event Grid can provide up to a million events per second, which could be the biggest DDOS cannon on the public cloud! Luckily, when you register a webhook subscriber, the first request contains a challenge that must be responded to correctly, else the subscription fails. The challenge request has the same structure as a normal event, however the <em>data</em> field contains a validation code that must be returned in the HTTP response.</p>
<pre><code class="hljs .language-json">[&#123;
  &quot;id&quot;: &quot;2d1781af-3a4c-4d7c-bd0c-e34b19da4e66&quot;,
  &quot;topic&quot;: &quot;&#x2F;subscriptions&#x2F;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;,
  &quot;subject&quot;: &quot;&quot;,
  &quot;data&quot;: &#123;
    &quot;validationCode&quot;: &quot;512d38b6-c7b8-40c8-89fe-f46f9e9622b6&quot;
  &#125;,
  &quot;eventType&quot;: &quot;Microsoft.EventGrid.SubscriptionValidationEvent&quot;,
  &quot;eventTime&quot;: &quot;2017-08-06T22:09:30.740323Z&quot;
&#125;]</code></pre>
<p>You must return the validation code as a validation response:<br><pre><code class="hljs .language-json">&#123;
  &quot;validationResponse&quot;: &quot;512d38b6-c7b8-40c8-89fe-f46f9e9622b6&quot;
&#125;</code></pre></p>
<p>Its also best practice to protect your webhook endpoint with a secret key. Its quite simple: just provide that key when setting up the subscription, and the request path contains that key before processing any event. Your webhook path should look like:</p>
<p><code>https://&lt;base_url&gt;/api/events?secret=YOUR_SECRET_KEY</code></p>
<h3 id="Handling-Incoming-Events-with-ASP-NET"><a href="#Handling-Incoming-Events-with-ASP-NET" class="headerlink" title="Handling Incoming Events with ASP.NET"></a>Handling Incoming Events with ASP.NET</h3><p>The key method on your controller accepts an HTTP Post and should return a 200 or 202, to ensure that event grid knows that the event has been received, and won’t retry.<br><pre><code class="hljs .language-csharp">public async Task&lt;HttpResponseMessage&gt; Post([FromBody]dynamic e)
&#123;
  foreach ( var azEvent in e)
  &#123;
    if (azEvent?.data?.validationCode !&#x3D; null)
    &#123;
      return Request.CreateResponse(HttpStatusCode.OK, new &#123; validationResponse &#x3D; x.data.validationCode &#125;);
    &#125;
    else
    &#123;
      HandleEvent(azEvent);
    &#125;
  &#125;
  return Request.CreateResponse(HttpStatusCode.OK);
&#125;</code></pre><br><a target="_blank" rel="noopener" href="https://gist.github.com/xtellurian/1ee357452668d7c3f46b83410c84435c">See this gist for the full controller code</a></p>
<h3 id="Creating-and-Subscribing-to-Topics-and-Events"><a href="#Creating-and-Subscribing-to-Topics-and-Events" class="headerlink" title="Creating and Subscribing to Topics and Events"></a>Creating and Subscribing to Topics and Events</h3><p>Event Grid topics are Azure resources, and must be placed in an Azure resource group. The resource group is a logical collection into which Azure resources are deployed and managed.</p>
<p>Follow these steps in the Azure Portal to use custom topics:</p>
<p><img src="/content/images/2017/10/eventgridportal.PNG" srcset="/img/loading.gif" alt="Creating Topics and Subs in the Azure Portal"></p>
<ol start="0">
<li>Create an Azure Resource Group if you don’t have one already.</li>
<li>Under <em>More Services</em> search for event grid, and select <strong>Event Grid Topics</strong></li>
<li>Create a new topic</li>
<li>Under <em>More Services</em> search for event grid, and select <strong>Event Grid Subscriptions</strong></li>
<li>Create a new subscription, and enter the endpoint you created as a webhook.</li>
</ol>
<p>You can follow detailed steps <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/event-grid/custom-event-quickstart-portal">here</a></p>
<h3 id="Dev-amp-Test-using-Ngrok"><a href="#Dev-amp-Test-using-Ngrok" class="headerlink" title="Dev &amp; Test using Ngrok"></a>Dev &amp; Test using Ngrok</h3><p>You can also get events directly to your local machine using <a target="_blank" rel="noopener" href="https://ngrok.com/">ngrok</a>. When you run a local server, there are listeners on local ports e.g. <code>localhost:44313/api/events</code>. Using ngrok, you can expose your local server to the web. After installing ngrok, run the following command: <code>ngrok http 44313 -host-header=&quot;localhost:44313&quot;</code> and you’ll have a public url you can then set as a new subscription.</p>
<p><img src="/content/images/2017/10/ngrokexample.PNG" srcset="/img/loading.gif" alt="Ngrok Screenshot"></p>
<p>Add your public ngrok url, with events path and key, as a new event subscription: <code>https://xxxxxx.ngrok.io/api/events?key=YOUR_SECRET_KEY</code></p>
<h3 id="Proactive-Bot-Messages"><a href="#Proactive-Bot-Messages" class="headerlink" title="Proactive Bot Messages"></a>Proactive Bot Messages</h3><p>Now your bot web server is receiving events, you can use that power to send proactive messages to users affected by that event. For example, you may generate an event every time users post a comment. You can <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/bot-framework/nodejs/bot-builder-nodejs-proactive-messages">read the documentation</a> of proactive messages on Microsoft Bot Framework, or there are <a target="_blank" rel="noopener" href="https://github.com/MicrosoftDX/botFramework-proactiveMessages">several samples on GitHub</a>.</p>
<p>A great use case for proactive messages is billing and payment requests. Every service provider wants a fast, reliable and easy billing experience for their customers. Imagine if your company’s digital assistant could proactively reach out to your customers, let them know their bill’s are almost due, and provide them simple ways to pay.</p>
<p><img src="/content/images/2017/10/PaymentRequest.PNG" srcset="/img/loading.gif" alt="Example of a Proactive Message for a Payment Request"></p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>Azure Event Grid is a great way to trigger proactive messages from intelligent bots - but there’s so much more it can do. It’s designed for modern applications, particularly those using serverless, because of its ability to scale. It lets you connect on-premises and cloud infrastructure via a fast and reliable messaging. It’s really fast, and super easy to use. 10/10 - would use again.</p>
<h3 id="Further-Reading"><a href="#Further-Reading" class="headerlink" title="Further Reading"></a>Further Reading</h3><ul>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/xtellurian/1ee357452668d7c3f46b83410c84435c">ASP.NET Controller for Event Grid Webhooks</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/event-grid/">Event Grid</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/event-grid/custom-event-quickstart-portal">Event Grid - Quickstart on the Azure Portal</a></li>
<li><a target="_blank" rel="noopener" href="https://ngrok.com/">ngrok</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/bot-framework/">Bot Framework</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/bot-framework/nodejs/bot-builder-nodejs-proactive-messages">Proactive Messages Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/MicrosoftDX/botFramework-proactiveMessages">Proactive Messages Samples</a></li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2018/03/11/xamarin-chatbots/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Building Xamarin.Forms Chatbots with Bot Framework Direct Line API</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2018/02/07/openai-windows/">
                        <span class="hidden-mobile">OpenAI Gym on Windows</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  









  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "Digital Assistants & Azure Event Grid&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>




















</body>
</html>
